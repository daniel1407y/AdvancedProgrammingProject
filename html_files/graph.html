<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph Visualization</title>
    <style>
        body {
            background-color: #bed0d3;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #network {
            width: 90%;
            height: 70%;
            border: 2px solid #344042;
            border-radius: 15px;
        }
        #controls {
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input[type="text"] {
            padding: 8px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.3/echarts.min.js"></script>
</head>
<body>
<div id="controls">
    <input type="text" id="searchBox" placeholder="Search node...">
    <button id="downloadBtn">Download Graph</button>
</div>
<div id="network"></div>
<script>
    const chart = echarts.init(document.getElementById('network'));

    const originalNodes = [
        // Nodes inserted here by HtmlGraphWriter.java
    ];
    const originalEdges = [
        // Edges inserted here by HtmlGraphWriter.java
    ];

    const option = {
        tooltip: {
            trigger: 'item',
            formatter: function (params) {
                if (params.dataType === 'node') {
                    return params.data.name;
                }
                return params.data.source + ' -> ' + params.data.target;
            }
        },
        animation: false,
        series: [{
            type: 'graph',
            layout: 'force',
            force: {
                repulsion: 500,
                edgeLength: 200
            },
            draggable: true,
            label: {
                show: true,
                position: 'top',
                fontSize: 16
            },
            lineStyle: {
                color: '#000',
                width: 2
            },
            edgeSymbol: ['circle', 'arrow'],
            edgeSymbolSize: [0, 15],
            symbolSize: 40,
        }]
    };

    chart.setOption(option);

    function updateGraph(nodes, edges) {
        chart.setOption({
            series: [{
                data: nodes,
                links: edges
            }]
        });
    }

    updateGraph(originalNodes, originalEdges);

    let highlightedNode = null;

    chart.on('click', function (params) {
        if (params.dataType === 'node') {
            if (highlightedNode === params.data.name) {
                highlightedNode = null;
                updateGraph(originalNodes, originalEdges);
            } else {
                highlightedNode = params.data.name;
                const connectedNodes = new Set();
                const highlightedNodes = [];
                const highlightedEdges = [];

                originalEdges.forEach(edge => {
                    if (edge.source === highlightedNode) {
                        connectedNodes.add(edge.target);
                    } else if (edge.target === highlightedNode) {
                        connectedNodes.add(edge.source);
                    }
                });

                highlightedNodes.push({ ...params.data });

                originalNodes.forEach(node => {
                    if (connectedNodes.has(node.name)) {
                        highlightedNodes.push({ ...node });
                    }
                });
                originalEdges.forEach(edge => {
                    if (edge.source === highlightedNode || edge.target === highlightedNode) {
                        highlightedEdges.push({ ...edge });
                    } else {
                        highlightedEdges.push(edge);
                    }
                });

                chart.setOption({
                    series: [{
                        data: highlightedNodes,
                        links: highlightedEdges
                    }]
                });
            }
        }
    });

    // Search Box Functionality
    document.getElementById('searchBox').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const filteredNodes = originalNodes.filter(node => node.name.toLowerCase().includes(searchTerm));
        updateGraph(filteredNodes, originalEdges);
    });

    // Download Button Functionality
    document.getElementById('downloadBtn').addEventListener('click', function () {
        const imgUrl = chart.getDataURL({
            pixelRatio: 2,
            backgroundColor: '#fff'
        });
        const link = document.createElement('a');
        link.href = imgUrl;
        link.download = 'graph.png';
        link.click();
    });

</script>
</body>
</html>
